<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Smart Life Multi-Language Chat</title>

<style>
body{
  margin:0;
  font-family:system-ui,-apple-system,"Segoe UI","Cairo",sans-serif;
  background:#0b1220;
  color:#fff;
  min-height:100vh;
  display:flex;
  flex-direction:column;
  transition:.3s ease;
}
header{
  padding:20px;
  border-bottom:1px solid rgba(255,255,255,.1);
  display:flex;
  align-items:center;
}
html[dir="rtl"] header{ flex-direction:row; justify-content:space-between; }
html[dir="ltr"] header{ flex-direction:row-reverse; justify-content:space-between; }

main{
  flex:1;
  display:flex;
  flex-direction:column;
  justify-content:center;
  padding:40px;
}
html[dir="rtl"] main{ text-align:right; }
html[dir="ltr"] main{ text-align:left; }

.dir-toggle{
  padding:8px 14px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.2);
  background:rgba(255,255,255,.08);
  color:#fff;
  cursor:pointer;
  font-weight:600;
}
</style>
</head>

<body>

<header>
  <h2 id="title">Ø³Ù…Ø§Ø±Øª Ù„Ø§ÙŠÙ</h2>
  <button id="dirToggleBtn" class="dir-toggle">ğŸŒ English</button>
</header>

<main>
  <h1 id="headline">Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ ğŸ‘‹</h1>
  <p id="desc">Ø§Ù„Ø¢Ù† Ø³ÙŠØªÙ… ØªØºÙŠÙŠØ± ØªÙ…ÙˆØ¶Ø¹ Ø§Ù„Ø´Ø§Øª Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù„ØºØ©.</p>
</main>

<!-- âœ… Bird SDK (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·) -->
<script
  src="https://embeddables.p.mbirdcdn.net/sdk/v0/bird-sdk.js"
  data-config-url="https://api.bird.com/workspaces/a00e85cb-1438-4c76-b1c7-a7e4f2ec3768/applications/7d702097-cc09-4d08-a20b-da3cbe9a1b61/signature/2024-06-17T17-12-51_796d7d7c62"
></script>

<script>
/* ========= Ø²Ø§Ø¦Ø± Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø«Ø§Ø¨Øª ========= */
function getOrCreateStableId(){
  const key = "sl_stable_visitor_id";
  let id = localStorage.getItem(key);
  if(!id){
    id = (crypto?.randomUUID?.() || ("sl_" + Date.now() + "_" + Math.random().toString(16).slice(2)));
    localStorage.setItem(key, id);
  }
  return id;
}

function buildVisitorProfile(lang){
  const stableId = getOrCreateStableId();
  const short = stableId.slice(-6).toLowerCase();

  return {
    stableId,
    // Ù†Ø³ØªØ®Ø¯Ù… emailaddress Ù„Ø£Ù†Ù‡ identifier Ø±Ø³Ù…ÙŠ Ø­Ø³Ø¨ Ø§Ù„Ø¯ÙˆÙƒ
    email: `visitor.${short}@smartlife.local`,
    displayName: (lang === "ar") ? `Ø²Ø§Ø¦Ø± Ø³Ù…Ø§Ø±Øª Ù„Ø§ÙŠÙ #${short.toUpperCase()}` : `SmartLife Visitor #${short.toUpperCase()}`,
    language: lang,
    subscribedAppInbox: true
  };
}

/* âœ… Identify ÙÙˆØ± ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù€ SDK */
Bird.eventTarget.addEventListener('bird-sdk-initialized', async () => {
  try {
    const lang = localStorage.getItem("site_lang") || "ar";
    const profile = buildVisitorProfile(lang);

    await Bird.contact.identify({
      strategy: 'Visitor',
      identifier: { key: 'emailaddress', value: profile.email },
    });

    // Ø¥Ø±Ø³Ø§Ù„ Attributes (Ù‚Ø¯ Ù„Ø§ ØªØ¸Ù‡Ø± ÙÙŠ webhook sender.displayName Ù„ÙƒÙ† Ø³ØªØ¸Ù‡Ø± ÙÙŠ Contact Ø¯Ø§Ø®Ù„ CRM)
    if (Bird.contact.putAttributes) {
      // Ø¨Ø¹Ø¶ Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚/SDK ØªØ³ØªØ®Ø¯Ù… putAttributes
      await Bird.contact.putAttributes({
        displayName: profile.displayName,
        language: profile.language,
        subscribedAppInbox: profile.subscribedAppInbox,
        stableVisitorId: profile.stableId,
        source: "website_widget"
      });
    } else if (Bird.contact.updateCurrent) {
      // ÙˆØ¨Ø¹Ø¶Ù‡Ø§ ØªØ³ØªØ®Ø¯Ù… updateCurrent
      await Bird.contact.updateCurrent({
        displayName: profile.displayName,
        language: profile.language,
        subscribedAppInbox: profile.subscribedAppInbox,
        stableVisitorId: profile.stableId,
        source: "website_widget"
      });
    }

    console.log("[Bird] Identified:", profile.email, profile.displayName);
  } catch (e) {
    console.warn("[Bird] Identify/Attributes failed:", e);
  }
});

/* ======== ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø§ØªØ¬Ø§Ù‡ (Ø¨Ø¯ÙˆÙ† Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù€ SDK) ======== */
const toggleBtn = document.getElementById("dirToggleBtn");
const html = document.documentElement;

function updateDirection(dir){
  const lang = dir === "rtl" ? "ar" : "en";

  html.setAttribute("dir", dir);
  html.setAttribute("lang", lang);

  if(lang === "ar"){
    toggleBtn.textContent = "ğŸŒ English";
    document.getElementById("headline").textContent = "Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ ğŸ‘‹";
    document.getElementById("desc").textContent = "Ø§Ù„Ø¢Ù† Ø³ÙŠØªÙ… ØªØºÙŠÙŠØ± ØªÙ…ÙˆØ¶Ø¹ Ø§Ù„Ø´Ø§Øª Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù„ØºØ©.";
  } else {
    toggleBtn.textContent = "ğŸŒ Ø¹Ø±Ø¨ÙŠ";
    document.getElementById("headline").textContent = "Welcome ğŸ‘‹";
    document.getElementById("desc").textContent = "Chat position now changes correctly.";
  }

  localStorage.setItem("site_lang", lang);

  // (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) ØªØ­Ø¯ÙŠØ« Attributes Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù„ØºØ© Ø¥Ø°Ø§ ØªØ¨ØºÙ‰
  if (window.Bird?.contact?.putAttributes) {
    const p = buildVisitorProfile(lang);
    Bird.contact.putAttributes({ language: p.language, displayName: p.displayName });
  } else if (window.Bird?.contact?.updateCurrent) {
    const p = buildVisitorProfile(lang);
    Bird.contact.updateCurrent({ language: p.language, displayName: p.displayName });
  }
}

const savedLang = localStorage.getItem("site_lang") || "ar";
updateDirection(savedLang === "ar" ? "rtl" : "ltr");

toggleBtn.addEventListener("click", ()=>{
  const currentDir = html.getAttribute("dir");
  updateDirection(currentDir === "rtl" ? "ltr" : "rtl");
});
</script>

</body>
</html>
