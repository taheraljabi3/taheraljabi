<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Smart Life Multi-Language Chat</title>

<style>
body{
  margin:0;
  font-family:system-ui,-apple-system,"Segoe UI","Cairo",sans-serif;
  background:#0b1220;
  color:#fff;
  min-height:100vh;
  display:flex;
  flex-direction:column;
  transition:.3s ease;
}

/* HEADER */
header{
  padding:20px;
  border-bottom:1px solid rgba(255,255,255,.1);
  display:flex;
  align-items:center;
}

html[dir="rtl"] header{
  flex-direction:row;
  justify-content:space-between;
}

html[dir="ltr"] header{
  flex-direction:row-reverse;
  justify-content:space-between;
}

/* MAIN */
main{
  flex:1;
  display:flex;
  flex-direction:column;
  justify-content:center;
  padding:40px;
}

html[dir="rtl"] main{ text-align:right; }
html[dir="ltr"] main{ text-align:left; }

/* LANGUAGE BUTTON */
.dir-toggle{
  padding:8px 14px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.2);
  background:rgba(255,255,255,.08);
  color:#fff;
  cursor:pointer;
  font-weight:600;
}
</style>
</head>

<body>

<header>
  <h2 id="title">Ø³Ù…Ø§Ø±Øª Ù„Ø§ÙŠÙ</h2>
  <button id="dirToggleBtn" class="dir-toggle">ğŸŒ English</button>
</header>

<main>
  <h1 id="headline">Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ ğŸ‘‹</h1>
  <p id="desc">Ø§Ù„Ø¢Ù† Ø³ÙŠØªÙ… ØªØºÙŠÙŠØ± ØªÙ…ÙˆØ¶Ø¹ Ø§Ù„Ø´Ø§Øª Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù„ØºØ©.</p>
</main>

<script>
/* ======== Ø¶Ø¹ Ù‡Ù†Ø§ Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ÙˆÙŠØ¯Ø¬Øª ======== */
const AR_WIDGET_URL = "https://api.bird.com/workspaces/a00e85cb-1438-4c76-b1c7-a7e4f2ec3768/applications/7d702097-cc09-4d08-a20b-da3cbe9a1b61/signature/2024-06-17T17-12-51_796d7d7c62";
const EN_WIDGET_URL = "https://api.bird.com/workspaces/a00e85cb-1438-4c76-b1c7-a7e4f2ec3768/applications/7d702097-cc09-4d08-a20b-da3cbe9a1b61/signature/2024-06-17T17-12-51_796d7d7c62";
/* ===================================== */

let currentScript = null;

/* ========= Ø£Ø¯ÙˆØ§Øª ID Ø«Ø§Ø¨Øª Ù„Ù„Ø²Ø§Ø¦Ø± ========= */
function getOrCreateStableVisitorId(){
  const key = "sl_bird_external_id";
  let id = localStorage.getItem(key);
  if(!id){
    // crypto.randomUUID Ù…Ø¯Ø¹ÙˆÙ…Ø© ÙÙŠ Ø£ØºÙ„Ø¨ Ø§Ù„Ù…ØªØµÙØ­Ø§Øª Ø§Ù„Ø­Ø¯ÙŠØ«Ø©
    id = (crypto?.randomUUID?.() || ("sl_" + Date.now() + "_" + Math.random().toString(16).slice(2)));
    localStorage.setItem(key, id);
  }
  return id;
}

function buildVisitorProfile(lang){
  const externalId = getOrCreateStableVisitorId();
  const short = externalId.slice(-6).toUpperCase();

  return {
    externalId,
    displayName: lang === "ar" ? `Ø²Ø§Ø¦Ø± Ø³Ù…Ø§Ø±Øª Ù„Ø§ÙŠÙ #${short}` : `SmartLife Visitor #${short}`,
    // Ø§ÙŠÙ…ÙŠÙ„ Ø§ÙØªØ±Ø§Ø¶ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) - ØªÙ‚Ø¯Ø± ØªØ´ÙŠÙ„Ù‡ Ø¥Ø°Ø§ Ù…Ø§ ØªØ¨ØºØ§Ù‡
    email: `visitor.${short.toLowerCase()}@example.com`,
    language: lang,
    subscribedAppInbox: true
  };
}

/* ========= ØªØ­Ù…ÙŠÙ„ Bird SDK Ø¨Ø´ÙƒÙ„ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ ========= */
function loadBirdWidget(locale){
  const lang = (locale === "ar") ? "ar" : "en";
  const profile = buildVisitorProfile(lang);

  // ØªØ¹Ø±ÙŠÙ birdAsyncInit Ù‚Ø¨Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³ÙƒØ±Ø¨Øª
  window.birdAsyncInit = async function (sdk) {
    try {
      // 1) Identify Ø¨Ù‡ÙˆÙŠØ© Ø«Ø§Ø¨ØªØ©
      await sdk.contact.identify({
        strategy: "Visitor",
        identifier: { key: "external_id", value: profile.externalId }
      });

      // 2) Ø¥Ø±Ø³Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ© + Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ App Inbox
      // Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¨Ø¹Ø¶ Ø§Ù„Ø¥ØµØ¯Ø§Ø±Ø§Øª ØªØ³ØªØ®Ø¯Ù… putAttributes Ø¨Ø¯Ù„ updateCurrent
      if (sdk.contact.updateCurrent) {
        await sdk.contact.updateCurrent({
          displayName: profile.displayName,
          email: profile.email,
          language: profile.language,
          subscribedAppInbox: profile.subscribedAppInbox,
          source: "website_widget"
        });
      } else if (sdk.contact.putAttributes) {
        await sdk.contact.putAttributes({
          displayName: profile.displayName,
          email: profile.email,
          language: profile.language,
          subscribedAppInbox: profile.subscribedAppInbox,
          source: "website_widget"
        });
      }

      // Debug (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
      console.log("[Bird] Identified as:", profile.externalId, profile.displayName);
    } catch (e) {
      console.warn("[Bird] Identify/Update failed:", e);
    }
  };

  // Ø­Ø°Ù Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¥Ù† ÙˆØ¬Ø¯
  if(currentScript) currentScript.remove();

  // Ø­Ø°Ù Ø£ÙŠ iframe Ø³Ø§Ø¨Ù‚ (Ø§Ø­ØªÙŠØ§Ø·ÙŠ)
  document.querySelectorAll("iframe").forEach(f=>{
    if(f.src && f.src.includes("bird")) f.remove();
  });

  const script = document.createElement("script");
  script.src = "https://embeddables.p.mbirdcdn.net/sdk/v0/bird-sdk.js";
  script.setAttribute("data-config-url", lang === "ar" ? AR_WIDGET_URL : EN_WIDGET_URL);
  script.async = true;

  document.head.appendChild(script);
  currentScript = script;
}

/* ======== ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø§ØªØ¬Ø§Ù‡ ======== */
const toggleBtn = document.getElementById("dirToggleBtn");
const html = document.documentElement;

function updateDirection(dir){
  const lang = dir === "rtl" ? "ar" : "en";

  html.setAttribute("dir", dir);
  html.setAttribute("lang", lang);

  if(lang === "ar"){
    toggleBtn.textContent = "ğŸŒ English";
    document.getElementById("headline").textContent = "Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ ğŸ‘‹";
    document.getElementById("desc").textContent = "Ø§Ù„Ø¢Ù† Ø³ÙŠØªÙ… ØªØºÙŠÙŠØ± ØªÙ…ÙˆØ¶Ø¹ Ø§Ù„Ø´Ø§Øª Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù„ØºØ©.";
  } else {
    toggleBtn.textContent = "ğŸŒ Ø¹Ø±Ø¨ÙŠ";
    document.getElementById("headline").textContent = "Welcome ğŸ‘‹";
    document.getElementById("desc").textContent = "Chat position now changes correctly.";
  }

  localStorage.setItem("site_lang", lang);

  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆÙŠØ¯Ø¬Øª Ù…Ø¹ Ù†ÙØ³ Ù‡ÙˆÙŠØ© Ø§Ù„Ø²Ø§Ø¦Ø± Ø§Ù„Ø«Ø§Ø¨ØªØ©
  loadBirdWidget(lang);
}

/* ======== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù„ØºØ© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© ======== */
const savedLang = localStorage.getItem("site_lang") || "ar";
updateDirection(savedLang === "ar" ? "rtl" : "ltr");

/* ======== Ø­Ø¯Ø« Ø§Ù„Ø²Ø± ======== */
toggleBtn.addEventListener("click", ()=>{
  const currentDir = html.getAttribute("dir");
  updateDirection(currentDir === "rtl" ? "ltr" : "rtl");
});
</script>

</body>
</html>
