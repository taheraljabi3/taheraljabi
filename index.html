<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ù…Ù‚Ø§Ù„Ø§Øª ØªÙ‚Ù†ÙŠØ© - Ø£Ø­Ø¯Ø« Ø§Ù„Ø£Ø®Ø¨Ø§Ø± ÙˆØ§Ù„Ø§Ø¨ØªÙƒØ§Ø±Ø§Øª</title>
  <meta name="description" content="ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø¢Ø®Ø± Ø§Ù„Ø£Ø®Ø¨Ø§Ø± ÙÙŠ Ø¹Ø§Ù„Ù… Ø§Ù„ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ Ù…Ù† Ø®Ù„Ø§Ù„ Ù…Ù‚Ø§Ù„Ø§Øª Ù…ØªØ®ØµØµØ© ØªØºØ·ÙŠ Ø§Ù„Ø¨Ø±Ù…Ø¬Ø©ØŒ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠØŒ ÙˆØ§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø°ÙƒÙŠØ©.">
  <meta name="keywords" content="ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§, Ø¨Ø±Ù…Ø¬Ø©, Ù…Ù‚Ø§Ù„Ø§Øª ØªÙ‚Ù†ÙŠØ©, Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ, Ø£Ø®Ø¨Ø§Ø± Ø§Ù„ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§">
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="style.css">
  <meta name="google-site-verification" content="9Ct3HVF2_BQj4h6--0d3mcexLU9dnwjC_9YJMhCdaT0" />

  <style>
    :root {
      --ai-bg: #ffffff;
      --ai-text: #111;
      --ai-muted: rgba(0,0,0,.6);
      --ai-border: rgba(0,0,0,.10);
      --ai-shadow: 0 18px 60px rgba(0,0,0,.25);
      --ai-shadow-soft: 0 12px 30px rgba(0,0,0,.12);
      --ai-brand: #111;
      --ai-brand-2: #333;
      --ai-success: #35d07f;
      --ai-surface: #f6f7f9;
    }

    .ai-chat {
      position: fixed;
      bottom: 18px;
      left: 18px;
      z-index: 9999;
      direction: rtl;
      font-family: system-ui, -apple-system, Segoe UI, Tahoma, Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Ù„Ùˆ ØªØ¨ØºØ§Ù‡ ÙŠÙ…ÙŠÙ† ØªØ­Øª Ø¨Ø¯Ù„ ÙŠØ³Ø§Ø±ØŒ ÙØ¹Ù‘Ù„ Ù‡Ø°ÙŠ:
    .ai-chat { right: 18px; left: auto; }
    .ai-chat__panel { right: 0; left: auto; }
    */

    .ai-chat__fab {
      width: 56px;
      height: 56px;
      border: none;
      border-radius: 16px;
      cursor: pointer;
      box-shadow: 0 12px 30px rgba(0,0,0,.18);
      background: var(--ai-brand);
      color: #fff;
      font-size: 22px;
      display: grid;
      place-items: center;
      transition: transform .15s ease, box-shadow .15s ease, opacity .15s ease;
      user-select: none;
    }
    .ai-chat__fab:hover { transform: translateY(-2px); box-shadow: 0 16px 36px rgba(0,0,0,.22); }
    .ai-chat__fab:active { transform: translateY(0); }
    .ai-chat__fab:disabled { opacity: .65; cursor: not-allowed; }

    .ai-chat__panel {
      width: 360px;
      max-width: calc(100vw - 36px);
      height: 520px;
      max-height: calc(100vh - 120px);
      background: var(--ai-bg);
      border-radius: 18px;
      box-shadow: var(--ai-shadow);
      overflow: hidden;
      position: absolute;
      bottom: 70px;
      left: 0;
      display: none;
      border: 1px solid rgba(0,0,0,.06);
    }
    .ai-chat__panel[aria-hidden="false"] { display: block; }

    .ai-chat__header {
      padding: 14px 14px 12px;
      background: linear-gradient(135deg, var(--ai-brand), var(--ai-brand-2));
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .ai-chat__title { display: flex; align-items: center; gap: 10px; min-width: 0; }
    .ai-chat__dot {
      width: 10px; height: 10px; border-radius: 50%;
      background: var(--ai-success);
      box-shadow: 0 0 0 4px rgba(53,208,127,.18);
      flex: 0 0 auto;
    }
    .ai-chat__name { font-weight: 800; font-size: 14px; line-height: 1.2; }
    .ai-chat__status { font-size: 12px; opacity: .88; }

    .ai-chat__actions { display: flex; gap: 6px; flex: 0 0 auto; }
    .ai-chat__iconbtn {
      width: 34px; height: 30px;
      border: 1px solid rgba(255,255,255,.25);
      background: rgba(255,255,255,.08);
      color: #fff;
      border-radius: 10px;
      cursor: pointer;
      transition: background .15s ease, transform .15s ease;
      user-select: none;
    }
    .ai-chat__iconbtn:hover { background: rgba(255,255,255,.14); transform: translateY(-1px); }
    .ai-chat__iconbtn:active { transform: translateY(0); }

    /* âœ… Ø¬Ø³Ù… Ø§Ù„Ø´Ø§Øª ØµØ§Ø± Ø·Ø¨Ù‚ØªÙŠÙ† Ø¯Ø§Ø®Ù„ Ù†ÙØ³ Ø§Ù„Ù„ÙˆØ­Ø© */
    .ai-chat__body {
      position: relative;
      height: calc(100% - 58px);
      background: var(--ai-surface);
    }

    .chat-layer {
      position: absolute;
      inset: 0;
      display: none;
    }
    .chat-layer.is-active { display: block; }

    .ai-chat__messages {
      padding: 14px;
      height: calc(100% - 92px);
      overflow: auto;
      background: var(--ai-surface);
    }

    .ai-msg { display: flex; margin: 10px 0; gap: 8px; }
    .ai-msg--user { justify-content: flex-end; }
    .ai-msg--bot  { justify-content: flex-start; }

    .ai-bubble {
      max-width: 80%;
      padding: 10px 12px;
      border-radius: 14px;
      line-height: 1.7;
      font-size: 13.5px;
      white-space: pre-wrap;
      word-break: break-word;
      border: 1px solid transparent;
    }

    .ai-msg--user .ai-bubble {
      background: var(--ai-brand);
      color: #fff;
      border-bottom-left-radius: 14px;
      border-bottom-right-radius: 6px;
    }

    .ai-msg--bot .ai-bubble {
      background: #fff;
      color: var(--ai-text);
      border: 1px solid rgba(0,0,0,.08);
      border-bottom-right-radius: 14px;
      border-bottom-left-radius: 6px;
    }

    .ai-meta { font-size: 11px; opacity: .65; margin-top: 4px; }

    .ai-chat__footer {
      padding: 10px 12px 12px;
      background: #fff;
      border-top: 1px solid rgba(0,0,0,.08);
      height: 92px;
      box-sizing: border-box;
    }

    .ai-chat__hint {
      font-size: 12px;
      color: var(--ai-muted);
      margin-bottom: 8px;
    }

    .ai-chat__form { display: flex; gap: 8px; align-items: center; }
    .ai-chat__input {
      flex: 1;
      border: 1px solid rgba(0,0,0,.14);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 13.5px;
      outline: none;
      background: #fff;
      transition: border-color .15s ease, box-shadow .15s ease;
    }
    .ai-chat__input:focus {
      border-color: rgba(0,0,0,.35);
      box-shadow: 0 0 0 4px rgba(0,0,0,.06);
    }

    .ai-chat__send {
      border: none;
      border-radius: 12px;
      padding: 10px 14px;
      background: var(--ai-brand);
      color: #fff;
      cursor: pointer;
      font-weight: 700;
      user-select: none;
      transition: transform .15s ease, opacity .15s ease;
    }
    .ai-chat__send:hover { transform: translateY(-1px); }
    .ai-chat__send:active { transform: translateY(0); }
    .ai-chat__send:disabled { opacity: .65; cursor: not-allowed; transform: none; }

    .ai-chat__badge {
      display: inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.06);
      color: rgba(0,0,0,.8);
      font-size: 12px;
      margin: 6px 0 2px;
      border: 1px solid rgba(0,0,0,.06);
    }

    .ai-typing { display: inline-flex; gap: 4px; align-items: center; padding: 2px 0; }
    .ai-typing span {
      width: 6px; height: 6px; border-radius: 50%;
      background: rgba(0,0,0,.35);
      animation: aiDot 1.1s infinite ease-in-out;
    }
    .ai-typing span:nth-child(2){ animation-delay: .15s; }
    .ai-typing span:nth-child(3){ animation-delay: .3s; }
    @keyframes aiDot {
      0%, 100% { transform: translateY(0); opacity: .5; }
      50% { transform: translateY(-4px); opacity: 1; }
    }

    /* âœ… Ø·Ø¨Ù‚Ø© MessageBird Ø¯Ø§Ø®Ù„ Ù†ÙØ³ Ø§Ù„Ù„ÙˆØ­Ø© (ÙˆØ§Ø¬Ù‡Ø© Ø§Ù†ØªÙ‚Ø§Ù„) */
    .mb-layer-wrap {
      height: 100%;
      display: flex;
      flex-direction: column;
    }
    .mb-center {
      flex: 1;
      display: grid;
      place-items: center;
      padding: 16px;
      text-align: center;
    }
    .mb-card {
      background: #fff;
      border: 1px solid rgba(0,0,0,.08);
      border-radius: 16px;
      box-shadow: var(--ai-shadow-soft);
      padding: 14px;
      max-width: 280px;
    }
    .mb-card b { display:block; margin-bottom: 6px; }
    .mb-card p { margin: 0; color: rgba(0,0,0,.7); font-size: 12.5px; line-height: 1.6; }

    @media (prefers-reduced-motion: reduce) {
      * { animation: none !important; transition: none !important; }
    }
  </style>
</head>

<body>
  <header>
    <h1>Ù…Ù‚Ø§Ù„Ø§Øª ØªÙ‚Ù†ÙŠØ©</h1>
    <nav>
      <ul>
        <li><a href="index.html">Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
        <li><a href="about.html">Ù…Ù† Ù†Ø­Ù†</a></li>
        <li><a href="services.html">Ø§Ù„Ø®Ø¯Ù…Ø§Øª</a></li>
        <li><a href="blog.html">Ø§Ù„Ù…Ø¯ÙˆÙ†Ø©</a></li>
        <li><a href="contact.html">Ø§ØªØµÙ„ Ø¨Ù†Ø§</a></li>
      </ul>
    </nav>
    <section id="search-section">
      <form id="search-form">
        <input type="text" id="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù‚Ø§Ù„..." />
        <button type="submit">Ø¨Ø­Ø«</button>
      </form>
    </section>
  </header>

  <main>
    <div id="carousel-background">
      <section id="featured-articles">
        <button class="carousel-control left" type="button" aria-label="Ø§Ù„Ø³Ø§Ø¨Ù‚">&lt;</button>

        <div class="carousel-wrapper">
          <div class="carousel"></div>
        </div>

        <button class="carousel-control right" type="button" aria-label="Ø§Ù„ØªØ§Ù„ÙŠ">&gt;</button>
      </section>
    </div>

    <section id="articles">
      <!-- (Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª ÙƒÙ…Ø§ Ù‡Ùˆ Ø¹Ù†Ø¯Ùƒ) -->
    </section>
  </main>

  <!-- âœ… ÙˆÙŠØ¯Ø¬Øª Ø§Ù„Ø´Ø§Øª Ø¨Ø·Ø¨Ù‚ØªÙŠÙ† -->
  <div id="aiChatWidget" class="ai-chat">
    <button id="aiChatFab" class="ai-chat__fab" aria-label="ÙØªØ­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©" type="button">ğŸ’¬</button>

    <div id="aiChatPanel" class="ai-chat__panel" aria-hidden="true" role="dialog" aria-label="Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø¯Ø¹Ù…">
      <div class="ai-chat__header">
        <div class="ai-chat__title">
          <div class="ai-chat__dot"></div>
          <div>
            <div class="ai-chat__name">Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø¯Ø¹Ù…</div>
            <div class="ai-chat__status" id="aiChatStatus">Ù…ØªØµÙ„</div>
          </div>
        </div>
        <div class="ai-chat__actions">
          <button id="aiChatMin" class="ai-chat__iconbtn" title="ØªØµØºÙŠØ±" type="button">â€”</button>
          <button id="aiChatClose" class="ai-chat__iconbtn" title="Ø¥ØºÙ„Ø§Ù‚" type="button">âœ•</button>
        </div>
      </div>

      <div class="ai-chat__body">
        <!-- ===== Layer 1: AI ===== -->
        <div id="aiLayer" class="chat-layer is-active">
          <div id="aiChatMessages" class="ai-chat__messages" aria-live="polite"></div>

          <div class="ai-chat__footer">
            <div class="ai-chat__hint" id="aiChatHint">Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒâ€¦ ÙˆØ¥Ø°Ø§ Ø§Ø­ØªØ¬Ù†Ø§ Ù…ÙˆØ¸Ù Ø¨Ù†Ø­ÙˆÙ‘Ù„Ùƒ Ù…Ø¨Ø§Ø´Ø±Ø©.</div>
            <form id="aiChatForm" class="ai-chat__form" autocomplete="off">
              <input
                id="aiChatInput"
                class="ai-chat__input"
                type="text"
                placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§â€¦"
                aria-label="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ"
                required
              />
              <button id="aiChatSend" class="ai-chat__send" type="submit">Ø¥Ø±Ø³Ø§Ù„</button>
            </form>
          </div>
        </div>

        <!-- ===== Layer 2: MessageBird ===== -->
        <div id="mbLayer" class="chat-layer">
          <div class="mb-layer-wrap">
            <div class="ai-chat__messages" aria-live="polite">
              <div class="mb-center">
                <div class="mb-card">
                  <b>ØªÙ… ØªØ­ÙˆÙŠÙ„Ùƒ Ù„Ù„Ø¯Ø¹Ù… Ø§Ù„Ø¨Ø´Ø±ÙŠ</b>
                  <p>Ø¬Ø§Ø±Ù ÙØªØ­ Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„Ø¢Ù†â€¦ Ø¥Ø°Ø§ Ù„Ù… ØªÙÙØªØ­ Ø®Ù„Ø§Ù„ Ø«ÙˆØ§Ù†ÙØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø²Ø± â€œÙØªØ­ Ø§Ù„Ø¯Ø¹Ù…â€.</p>
                </div>
              </div>
            </div>

            <div class="ai-chat__footer">
              <div class="ai-chat__hint">ØªÙ‚Ø¯Ø± ØªÙƒÙ…Ù„ Ù‡Ù†Ø§ Ù…Ø¹ Ø§Ù„Ù…ÙˆØ¸Ù Ø¹Ø¨Ø± MessageBird.</div>
              <button id="mbOpenBtn" class="ai-chat__send" type="button">ÙØªØ­ Ø§Ù„Ø¯Ø¹Ù…</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- âœ… Ø­Ù…Ø§ÙŠØ© Ù…Ù† Ø£ÙŠ ÙƒØ±Ø§Ø´ ÙÙŠ script.js (ÙƒØ§Ø±ÙˆØ³ÙŠÙ„) -->
  <script>
    window.addEventListener("error", (e) => {
      const msg = String(e?.message || "");
      if (msg.includes("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± ÙÙŠ Ø§Ù„ÙƒØ§Ø±ÙˆØ³ÙŠÙ„") || msg.toLowerCase().includes("carousel")) {
        console.warn("[SAFE-GUARD] Carousel error ignored:", msg);
        e.preventDefault?.();
        return true;
      }
    });
  </script>

  <script src="script.js"></script>

  <script>
  (() => {
    "use strict";

    const CONFIG = {
      N8N_WEBHOOK_URL: "https://taherahmedsaeed.app.n8n.cloud/webhook-test/264e35a3-2adb-48b8-9a58-3040e9ec8107",
      MESSAGEBIRD_WIDGET_ID: "703013fa-c1c4-4280-a6a0-d4ef3deb4438",
      REQUEST_TIMEOUT_MS: 25000,
      DEBUG: true,
    };

    const STORAGE = {
      SESSION_KEY: "ai_chat_session_id_v1",
      HISTORY_KEY: "ai_chat_history_v1",
      MODE_KEY: "ai_chat_mode_v1", // "ai" | "mb"
    };

    const sessionId =
      localStorage.getItem(STORAGE.SESSION_KEY) ||
      (crypto.randomUUID ? crypto.randomUUID() : (Date.now() + "-" + Math.random().toString(16).slice(2)));
    localStorage.setItem(STORAGE.SESSION_KEY, sessionId);

    const $ = (id) => document.getElementById(id);

    const fab = $("aiChatFab");
    const panel = $("aiChatPanel");
    const closeBtn = $("aiChatClose");
    const minBtn = $("aiChatMin");

    const aiLayer = $("aiLayer");
    const mbLayer = $("mbLayer");
    const mbOpenBtn = $("mbOpenBtn");

    const form = $("aiChatForm");
    const input = $("aiChatInput");
    const sendBtn = $("aiChatSend");
    const messagesEl = $("aiChatMessages");

    const statusEl = $("aiChatStatus");
    const hintEl = $("aiChatHint");

    if (!fab || !panel || !form || !input || !sendBtn || !messagesEl || !statusEl || !hintEl || !closeBtn || !minBtn || !aiLayer || !mbLayer || !mbOpenBtn) {
      console.error("[AI-CHAT] Missing DOM elements. Widget will not run.");
      return;
    }

    let chatMode = localStorage.getItem(STORAGE.MODE_KEY) || "ai"; // "ai" | "mb"
    let greeted = false;

    function logDebug(...args) {
      if (CONFIG.DEBUG) console.log("[AI-CHAT]", ...args);
    }

    function openPanel() {
      panel.setAttribute("aria-hidden", "false");
      setTimeout(() => input.focus(), 50);
    }
    function closePanel() {
      panel.setAttribute("aria-hidden", "true");
    }

    function switchToAiLayer() {
      aiLayer.classList.add("is-active");
      mbLayer.classList.remove("is-active");
      statusEl.textContent = "Ù…ØªØµÙ„";
      hintEl.textContent = "Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒâ€¦ ÙˆØ¥Ø°Ø§ Ø§Ø­ØªØ¬Ù†Ø§ Ù…ÙˆØ¸Ù Ø¨Ù†Ø­ÙˆÙ‘Ù„Ùƒ Ù…Ø¨Ø§Ø´Ø±Ø©.";
      input.disabled = false;
      sendBtn.disabled = false;
    }

    function switchToMbLayer() {
      aiLayer.classList.remove("is-active");
      mbLayer.classList.add("is-active");
      statusEl.textContent = "ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„";
      input.disabled = true;
      sendBtn.disabled = true;
    }

    function scrollToBottom() {
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function nowTime() {
      const d = new Date();
      return d.toLocaleTimeString("ar-SA", { hour: "2-digit", minute: "2-digit" });
    }

    function persistHistory(item) {
      try {
        const raw = localStorage.getItem(STORAGE.HISTORY_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        const safe = Array.isArray(arr) ? arr : [];
        safe.push(item);
        localStorage.setItem(STORAGE.HISTORY_KEY, JSON.stringify(safe.slice(-30)));
      } catch {}
    }

    function renderHistory() {
      if (messagesEl.childElementCount > 0) return;
      try {
        const raw = localStorage.getItem(STORAGE.HISTORY_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        if (!Array.isArray(arr) || !arr.length) return;

        arr.slice(-30).forEach((m) => {
          const wrap = document.createElement("div");
          wrap.className = "ai-msg ai-msg--" + (m.from || "bot");

          const bubble = document.createElement("div");
          bubble.className = "ai-bubble";
          bubble.textContent = String(m.text ?? "");

          const meta = document.createElement("div");
          meta.className = "ai-meta";
          meta.textContent = new Date(m.t || Date.now()).toLocaleTimeString("ar-SA", { hour: "2-digit", minute: "2-digit" });

          const container = document.createElement("div");
          container.appendChild(bubble);
          container.appendChild(meta);

          wrap.appendChild(container);
          messagesEl.appendChild(wrap);
        });

        scrollToBottom();
      } catch {}
    }

    function normalizeText(t) {
      return String(t ?? "").replace(/\s+/g, " ").trim();
    }

    function addMessage({ from, text }) {
      const wrap = document.createElement("div");
      wrap.className = "ai-msg ai-msg--" + from;

      const bubble = document.createElement("div");
      bubble.className = "ai-bubble";
      bubble.textContent = String(text ?? "");

      const meta = document.createElement("div");
      meta.className = "ai-meta";
      meta.textContent = nowTime();

      const container = document.createElement("div");
      container.appendChild(bubble);
      container.appendChild(meta);

      wrap.appendChild(container);
      messagesEl.appendChild(wrap);
      scrollToBottom();

      persistHistory({ from, text: String(text ?? ""), t: Date.now() });
    }

    function addBadge(text) {
      const b = document.createElement("div");
      b.className = "ai-chat__badge";
      b.textContent = text;
      messagesEl.appendChild(b);
      scrollToBottom();
    }

    function addTyping() {
      if ($("aiTyping")) return;
      const wrap = document.createElement("div");
      wrap.className = "ai-msg ai-msg--bot";
      wrap.id = "aiTyping";

      const bubble = document.createElement("div");
      bubble.className = "ai-bubble";

      const typing = document.createElement("div");
      typing.className = "ai-typing";
      typing.innerHTML = "<span></span><span></span><span></span>";

      bubble.appendChild(typing);
      wrap.appendChild(bubble);
      messagesEl.appendChild(wrap);
      scrollToBottom();
    }

    function removeTyping() {
      const t = $("aiTyping");
      if (t) t.remove();
    }

    function setBusy(isBusy) {
      // Busy only in AI mode
      if (chatMode !== "ai") return;
      sendBtn.disabled = isBusy;
      input.disabled = isBusy;
      statusEl.textContent = isBusy ? "Ø¬Ø§Ø±Ù Ø§Ù„Ø±Ø¯â€¦" : "Ù…ØªØµÙ„";
    }

    function greetOnce() {
      if (greeted) return;
      greeted = true;
      addMessage({ from: "bot", text: "Ù‡Ù„Ø§! Ø£Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø¯Ø¹Ù… ğŸ¤\nØ§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„ÙƒØŒ ÙˆØ¥Ø°Ø§ Ø§Ø­ØªØ¬Ù†Ø§ Ù…ÙˆØ¸Ù Ø¨Ø­ÙˆÙ‘Ù„Ùƒ ÙÙˆØ±Ù‹Ø§." });
    }

    function normalizeN8nResponse(anyData) {
      if (Array.isArray(anyData)) return anyData[0] || null;
      if (anyData && typeof anyData === "object") return anyData;

      if (typeof anyData === "string") {
        try {
          const j = JSON.parse(anyData);
          if (Array.isArray(j)) return j[0] || null;
          if (j && typeof j === "object") return j;
        } catch {}
        return { reply: anyData, mode: "continue" };
      }

      return null;
    }

    function extractReply(obj) {
      if (!obj || typeof obj !== "object") return null;
      const r =
        (typeof obj.reply === "string" && obj.reply.trim() ? obj.reply : null) ||
        (typeof obj.output === "string" && obj.output.trim() ? obj.output : null) ||
        null;
      return r ? normalizeText(r) : null;
    }

    function isHandoffResponse(obj) {
      return !!(obj && (obj.mode === "handoff" || obj.handoff === true));
    }

    async function sendToN8n(userText) {
      const body = { sessionId, page: location.href, message: userText, locale: "ar" };

      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), CONFIG.REQUEST_TIMEOUT_MS);

      try {
        const res = await fetch(CONFIG.N8N_WEBHOOK_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Accept": "application/json, text/plain, */*"
          },
          body: JSON.stringify(body),
          signal: controller.signal
        });

        if (!res.ok) throw new Error("n8n error: " + res.status);

        const txt = await res.text();
        logDebug("N8N TEXT (head):", txt.slice(0, 260));

        const obj = normalizeN8nResponse(txt);
        if (obj) return [obj];

        return [{ reply: txt, mode: "continue" }];
      } finally {
        clearTimeout(timeoutId);
      }
    }

    // ===== MessageBird (Lazy load) =====
    function loadMessageBirdWidgetIfNeeded() {
      if (document.getElementById("live-chat-widget-script")) return;

      window.MessageBirdChatWidgetSettings = {
        widgetId: CONFIG.MESSAGEBIRD_WIDGET_ID,
        initializeOnLoad: true,
      };

      const s = document.createElement("script");
      s.type = "text/javascript";
      s.async = true;
      s.id = "live-chat-widget-script";
      s.src = "https://livechat.messagebird.com/bootstrap.js?widgetId=" + encodeURIComponent(CONFIG.MESSAGEBIRD_WIDGET_ID);
      document.head.appendChild(s);
    }

    function openMessageBirdChat(contact) {
      loadMessageBirdWidgetIfNeeded();

      const start = Date.now();
      const timer = setInterval(() => {
        const api = window.MessageBirdChatWidget;

        if (api && typeof api.toggleChat === "function") {
          clearInterval(timer);

          try {
            if (api.identify && typeof api.identify === "function") {
              const c = contact || {};
              api.identify({
                externalId: c.id || sessionId,
                name: c.name,
                email: c.email,
                phone: c.phone,
              });
            }
          } catch (e) {
            logDebug("identify failed:", e);
          }

          try { api.toggleChat(); } catch (e) { logDebug("toggleChat failed:", e); }
        }

        if (Date.now() - start > 12000) {
          clearInterval(timer);
          // Ù„Ø§ Ù†Ø±Ø³Ù„ Ø¯Ø§Ø®Ù„ AI messages Ù„Ø£Ù†Ù†Ø§ Ø§Ù†ØªÙ‚Ù„Ù†Ø§ Ù„Ù„Ù€ MB layer
          console.warn("[AI-CHAT] MessageBird open timeout.");
        }
      }, 250);
    }

    function handoffToMessageBird(payloadObj) {
      chatMode = "mb";
      localStorage.setItem(STORAGE.MODE_KEY, "mb");

      // Switch UI layer
      switchToMbLayer();

      // Open MessageBird automatically
      const contact = payloadObj && payloadObj.contact ? payloadObj.contact : null;
      openMessageBirdChat(contact);

      // Backup button
      mbOpenBtn.onclick = () => openMessageBirdChat(contact);
    }

    // ===== Events =====
    fab.addEventListener("click", () => {
      const isOpen = panel.getAttribute("aria-hidden") === "false";
      if (isOpen) closePanel();
      else {
        openPanel();
        renderHistory();
        greetOnce();

        // Restore mode UI
        if (chatMode === "mb") switchToMbLayer();
        else switchToAiLayer();
      }
    });

    closeBtn.addEventListener("click", closePanel);
    minBtn.addEventListener("click", closePanel);

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      if (chatMode !== "ai") return;

      const text = normalizeText(input.value);
      if (!text) return;

      addMessage({ from: "user", text });
      input.value = "";

      setBusy(true);
      addTyping();

      try {
        const rawArr = await sendToN8n(text);
        removeTyping();

        logDebug("N8N RAW ARR:", rawArr);

        const obj = Array.isArray(rawArr) ? (rawArr[0] || null) : normalizeN8nResponse(rawArr);
        if (!obj) {
          addMessage({ from: "bot", text: "ÙˆØµÙ„ Ø±Ø¯ Ù…Ù† n8n Ø¨Ø´ÙƒÙ„ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹. ØªØ£ÙƒØ¯ Ø£Ù† Respond to Webhook ÙŠØ±Ø¬Ù‘Ø¹ reply/mode." });
          return;
        }

        const reply = extractReply(obj);

        if (isHandoffResponse(obj)) {
          addMessage({ from: "bot", text: reply || "ØªÙ… ØªØ­ÙˆÙŠÙ„ÙƒÙ… Ù„Ù„Ù…Ù‡Ù†Ø¯Ø³ Ø§Ù„Ù…Ù†Ø§ÙˆØ¨" });
          addBadge("Ø¬Ø§Ø±ÙŠ ÙØªØ­ Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„Ø¨Ø´Ø±ÙŠâ€¦");
          handoffToMessageBird(obj);
          return;
        }

        if (!reply) {
          addMessage({ from: "bot", text: "ÙˆØµÙ„ Ø±Ø¯ Ù…Ù† n8n Ù„ÙƒÙ† Ø¨Ø¯ÙˆÙ† Ù†Øµ ÙˆØ§Ø¶Ø­. ØªØ£ÙƒØ¯ Ø£Ù† Respond to Webhook ÙŠØ±Ø¬Ù‘Ø¹ reply." });
          if (CONFIG.DEBUG) addBadge("DEBUG OBJ: " + JSON.stringify(obj).slice(0, 240));
          return;
        }

        addMessage({ from: "bot", text: reply });

      } catch (err) {
        removeTyping();

        const msg =
          (err && err.name === "AbortError")
            ? "Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ (Timeout). ØªØ£ÙƒØ¯ Ø£Ù† n8n ÙŠØ±Ø¯ Ø¨Ø³Ø±Ø¹Ø© Ø£Ùˆ Ø²ÙØ¯ Ø§Ù„Ù…Ù‡Ù„Ø©."
            : "ØµØ§Ø± Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„ÙˆÙŠØ¨Ù‡ÙˆÙƒ. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·/Ø§Ù„Ù€ CORS ÙˆØ­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ©.";

        addMessage({ from: "bot", text: msg });
        logDebug("ERROR:", err);
      } finally {
        setBusy(false);
      }
    });

    // Boot (restore mode UI without opening panel)
    if (chatMode === "mb") {
      // Ù…Ø§ Ù†ÙØªØ­ MB ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¥Ù„Ø§ Ù„Ù…Ø§ ÙŠÙØªØ­ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù„ÙˆØ­Ø© (Ø¹Ø´Ø§Ù† user gesture)
      // Ù„ÙƒÙ† Ù†Ø¸Ù‡Ø± Ø§Ù„Ø­Ø§Ù„Ø© Ù…Ø­ÙÙˆØ¸Ø©
      // Ø¥Ø°Ø§ ØªØ¨ØºØ§Ù‡ ÙŠÙØªØ­ MB Ù…Ø¨Ø§Ø´Ø±Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­ÙˆÙŠÙ„ØŒ Ù‚Ù„Ù‘ÙŠ ÙˆØ£ÙØ¹Ù„Ù‡
    }

    setBusy(false);

  })();
  </script>

  <footer>
    <p>Â© 2024 Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© - Ø§Ù„Ø¬Ø§Ø¨ÙŠ ØªÙŠÙƒ</p>
  </footer>
</body>
</html>
