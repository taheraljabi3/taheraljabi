<script>
/* ======== Ø¶Ø¹ Ù‡Ù†Ø§ Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ÙˆÙŠØ¯Ø¬Øª ======== */
const AR_WIDGET_URL = "PUT_ARABIC_WIDGET_CONFIG_URL_HERE";
const EN_WIDGET_URL = "PUT_ENGLISH_WIDGET_CONFIG_URL_HERE";
/* ===================================== */

let currentScript = null;

/** ØªÙˆÙ„ÙŠØ¯ ID Ø¨Ø³ÙŠØ· (Ø¨Ø¯ÙˆÙ† Ù…ÙƒØªØ¨Ø§Øª) */
function genId(prefix="guest"){
  return `${prefix}_${Date.now()}_${Math.random().toString(16).slice(2)}`;
}

/** Ø¬Ù‡Ù‘Ø² â€œÙ…Ø³ØªØ®Ø¯Ù… Ø§ÙØªØ±Ø§Ø¶ÙŠâ€ Ø«Ø§Ø¨Øª */
function getOrCreateFakeUser(lang){
  const key = "fake_bird_user";
  const existing = localStorage.getItem(key);
  if (existing) {
    try { return JSON.parse(existing); } catch(e) {}
  }

  const id = genId("sl");
  const user = {
    externalId: id,
    displayName: lang === "ar" ? `Ø²Ø§Ø¦Ø± Ø³Ù…Ø§Ø±Øª Ù„Ø§ÙŠÙ ${id.slice(-4)}` : `SmartLife Visitor ${id.slice(-4)}`,
    email: `visitor.${id.slice(-6)}@example.com`,
    language: lang
  };

  localStorage.setItem(key, JSON.stringify(user));
  return user;
}

/** Ù†Ø­Ù…Ù‘Ù„ Ø§Ù„Ù€ SDK + Ù†Ø¹Ø±Ù‘Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… + Ù†Ø±Ø³Ù„ Attributes */
function loadBirdWidget(locale){
  // Ø­Ø°Ù Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¥Ù† ÙˆØ¬Ø¯
  if (currentScript) currentScript.remove();

  // Ø­Ø°Ù Ø£ÙŠ iframe Ø³Ø§Ø¨Ù‚ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
  document.querySelectorAll("iframe").forEach(f=>{
    if (f.src && f.src.includes("bird")) f.remove();
  });

  // Ù…Ù‡Ù…: Ù‚Ø¨Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³ÙƒØ±Ø¨ØªØŒ Ø¬Ù‡Ù‘Ø² birdAsyncInit Ø¹Ø´Ø§Ù† ØªØ´ØªØºÙ„ Ø£ÙˆÙ„ Ù…Ø§ ÙŠØ¬Ù‡Ø² Ø§Ù„Ù€ SDK
  window.birdAsyncInit = async function (sdk, conf) {
    // ØºØ§Ù„Ø¨Ø§Ù‹ Ø§Ù„Ø³ÙƒØ±Ø¨Øª ÙŠÙ€ init Ù†ÙØ³Ù‡ØŒ Ù„ÙƒÙ† Ù‡Ø°Ø§ Ù…Ø«Ø§Ù„ Ù„Ùˆ ØªØ¨ØºÙ‰ ØªØ¹Ø¯Ù‘Ù„ config
    // await sdk.init({ config: conf });

    const fake = getOrCreateFakeUser(locale);

    // 1) Identify Ø¨Ù‡ÙˆÙŠØ© Ø«Ø§Ø¨ØªØ© (Ø¨Ø¯Ù„ anonymousId)
    // Ù„Ø§Ø­Ø¸: identify ÙŠÙ‚Ø¨Ù„ claim + (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) contactAttributes Ø­Ø³Ø¨ Ø§Ù„Ø¯ÙˆÙƒ :contentReference[oaicite:2]{index=2}
    await sdk.contact.identify(
      {
        strategy: "Visitor",
        identifier: { key: "external_id", value: fake.externalId }
      }
      // Ø¨Ø¹Ø¶ Ø§Ù„Ø¨ÙŠØ¦Ø§Øª ØªØ¯Ø¹Ù… ØªÙ…Ø±ÙŠØ± contactAttributes Ù‡Ù†Ø§ØŒ Ù„ÙƒÙ† Ø¹Ø´Ø§Ù† ÙŠÙƒÙˆÙ† Ù…Ø¶Ù…ÙˆÙ† Ù†Ø®Ù„ÙŠÙ‡Ø§ Ø¹Ø¨Ø± updateCurrent
    );

    // 2) Attributes ØªØ¸Ù‡Ø± Ø¹Ø§Ø¯Ø© Ø¶Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù€ Contact Ù„Ù„Ù…ÙˆØ¸Ù
    await sdk.contact.updateCurrent({
      displayName: fake.displayName,
      email: fake.email,
      language: fake.language,
      source: "website_widget"
    });
  };

  const script = document.createElement("script");
  script.src = "https://embeddables.p.mbirdcdn.net/sdk/v0/bird-sdk.js";
  script.setAttribute("data-config-url", locale === "ar" ? AR_WIDGET_URL : EN_WIDGET_URL);
  script.async = true;

  document.head.appendChild(script);
  currentScript = script;
}

/* ======== ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø§ØªØ¬Ø§Ù‡ ======== */
const toggleBtn = document.getElementById("dirToggleBtn");
const html = document.documentElement;

function updateDirection(dir){
  const lang = dir === "rtl" ? "ar" : "en";

  html.setAttribute("dir", dir);
  html.setAttribute("lang", lang);

  if(lang === "ar"){
    toggleBtn.textContent = "ðŸŒ English";
    document.getElementById("headline").textContent = "Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ ðŸ‘‹";
    document.getElementById("desc").textContent = "Ø§Ù„Ø¢Ù† Ø³ÙŠØªÙ… ØªØºÙŠÙŠØ± ØªÙ…ÙˆØ¶Ø¹ Ø§Ù„Ø´Ø§Øª Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù„ØºØ©.";
  } else {
    toggleBtn.textContent = "ðŸŒ Ø¹Ø±Ø¨ÙŠ";
    document.getElementById("headline").textContent = "Welcome ðŸ‘‹";
    document.getElementById("desc").textContent = "Chat position now changes correctly.";
  }

  localStorage.setItem("site_lang", lang);
  loadBirdWidget(lang);
}

const savedLang = localStorage.getItem("site_lang") || "ar";
updateDirection(savedLang === "ar" ? "rtl" : "ltr");

toggleBtn.addEventListener("click", ()=>{
  const currentDir = html.getAttribute("dir");
  updateDirection(currentDir === "rtl" ? "ltr" : "rtl");
});
</script>
